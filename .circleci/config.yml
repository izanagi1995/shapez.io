# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Orchestrate or schedule a set of jobs
commands:
  checkout-deps-install:
    steps:
      - checkout
      - run:
          name: Install ffmpeg
          command: curl -L https://github.com/izanagi1995/ffmpeg-build-script/releases/download/4.3.1/ffmpeg -o /usr/local/bin/ffmpeg && chmod +x /usr/local/bin/ffmpeg
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}-v2
      - run:
          name: Install node deps
          command: yarn install --immutable
      - run:
          name: Install gulp globally
          command: yarn global add gulp
      - run:
          name: Install gulp node deps
          command: cd gulp && yarn install --immutable
      - run:
          name: Install electron node deps
          command: cd electron && yarn install --immutable
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}-v2
          paths:
            - ~/.cache/yarn
            - ~/project/node_modules
            - ~/project/gulp/node_modules
            - ~/project/electron/node_modules
jobs:
  signed-osx-build:
    macos:
      xcode: 12.2.0
    steps:
      - checkout-deps-install
      - run:
          name: Unpack certificate
          command: |
            printf "$DEV_CERTIFICATE" | base64 -d -o /tmp/cert.p12
            printf "$DEV_CERTIFICATE_SIGNING" | base64 -d -o /tmp/cert.cer
            security create-keychain -p '' "$KEYCHAIN_PATH"
            security import /tmp/cert.p12 -k "$KEYCHAIN_PATH" -P '' -A
            security import /tmp/cert.cer -k "$KEYCHAIN_PATH" -P '' -A
            
      - run:
          name: Debug identities
          command: |
            security find-identity -v "$KEYCHAIN_PATH"
            security find-identity -v "$KEYCHAIN_PATH" -p codesigning
      - run:
          name: Run the build
          no_output_timeout: 60m
          command: | 
            cd gulp
            yarn gulp build.standalone-prod
            yarn gulp standalone.prepare
            security unlock-keychain -p '' "$KEYCHAIN_PATH"
            security list-keychain -d user -s "$KEYCHAIN_PATH"
            DEBUG=* yarn gulp standalone.package.prod.darwin64
            cd ~/project/tmp_standalone_files/ && zip --symlinks -r shapez.io-standalone-darwin-x64.zip shapez.io-standalone-darwin-x64
      - store_artifacts:
            path: ~/project/tmp_standalone_files/shapez.io-standalone-darwin-x64.zip
workflows:
  # Name the workflow "welcome"
  signed-osx:
    jobs:
      - signed-osx-build