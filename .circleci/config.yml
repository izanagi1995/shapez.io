# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Orchestrate or schedule a set of jobs
commands:
  checkout-deps-install:
    steps:
      - checkout
      - restore_cache:
          name: Restore brew deps
          keys:
            - brew-deps
      # Fixme
      # - run: brew link libpng fontconfig frei0r lame lzo libass libvorbis libvpx opus rtmpdump sdl2 snappy theora x264 x265 xz libogg
      - run:
          name: Install brew deps
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install homebrew-ffmpeg/ffmpeg/ffmpeg
      - save_cache:
          name: Save brew deps to cache
          key: brew-deps
          paths:
            - /usr/local/Cellar
            - /usr/local/Homebrew
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install node deps
          command: yarn install --immutable
      - run:
          name: Install gulp globally
          command: yarn global add gulp
      - run:
          name: Install gulp node deps
          command: cd gulp && yarn install --immutable
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - ~/project/node_modules
jobs:
  unsigned-osx-build:
    macos:
      xcode: 12.2.0
    steps:
      - checkout-deps-install
      - run:
          name: ls debug
          command: ls
      - run:
          name: Run the build
          command: cd gulp && yarn gulp standalone.package.prod.darwin64.unsigned
workflows:
  # Name the workflow "welcome"
  unsigned-osx:
    jobs:
      - unsigned-osx-build