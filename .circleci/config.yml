# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Orchestrate or schedule a set of jobs
commands:
  checkout-deps-install:
    steps:
      - checkout
      - run:
          name: Install ffmpeg
          command: curl -L https://github.com/izanagi1995/ffmpeg-build-script/releases/download/4.3.1/ffmpeg -o /usr/local/bin/ffmpeg && chmod +x /usr/local/bin/ffmpeg
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}-v2
      - run:
          name: Install node deps
          command: yarn install --immutable
      - run:
          name: Install gulp globally
          command: yarn global add gulp
      - run:
          name: Install gulp node deps
          command: cd gulp && yarn install --immutable
      - run:
          name: Install electron node deps
          command: cd electron && yarn install --immutable
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}-v2
          paths:
            - ~/.cache/yarn
            - ~/project/node_modules
            - ~/project/gulp/node_modules
            - ~/project/electron/node_modules
jobs:
  unsigned-osx-build:
    macos:
      xcode: 12.2.0
    steps:
      - checkout-deps-install
      - run:
          name: ls debug
          command: ls
      - run:
          name: Run the build
          command: | 
            cd gulp
            yarn gulp build.standalone-prod
            yarn gulp standalone.prepare
            yarn gulp standalone.package.prod.darwin64.unsigned
            zip -r ~/project/tmp_standalone_files/shapez.io-standalone-darwin-x64.zip ~/project/tmp_standalone_files/shapez.io-standalone-darwin-x64
      - store_artifacts:
            path: ~/project/tmp_standalone_files/shapez.io-standalone-darwin-x64.zip
workflows:
  # Name the workflow "welcome"
  unsigned-osx:
    jobs:
      - unsigned-osx-build